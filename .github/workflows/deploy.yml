name: Deploy Spring Boot with Docker

on:
  push:
    branches: ["dev/test"] # ë°°í¬ ëŒ€ìƒ ë¸Œëœì¹˜
  pull_request:
    branches: ["dev/test"] # PR ì‹œì—ë„ ë™ì‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Java 17 ì„¤ì •
      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      # 3ï¸âƒ£ Gradle ë¹Œë“œ ìˆ˜í–‰ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Grant execute permission for Gradle and build
        run: |
          chmod +x ./gradlew
          ./gradlew spotlessApply  # ì½”ë“œ ìŠ¤íƒ€ì¼ ì ìš©
          ./gradlew clean build -x test --stacktrace

          echo "ğŸ” ë¹Œë“œëœ JAR íŒŒì¼ í™•ì¸:"
          ls -lh build/libs

          # JAR íŒŒì¼ ìë™ íƒìƒ‰ í›„ app.jarë¡œ ë³µì‚¬
          JAR_FILE=$(find build/libs -name "*.jar" ! -name "*plain.jar" | head -n 1)
          echo "ğŸ” ì°¾ì€ JAR íŒŒì¼: $JAR_FILE"
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤! ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          mv "$JAR_FILE" build/libs/app.jar  # Docker COPY ì—ëŸ¬ ë°©ì§€

      # 4ï¸âƒ£ JAR íŒŒì¼ ì••ì¶•
      - name: Compress JAR file
        run: |
          tar -czf app.tar.gz -C build/libs app.jar
          ls -lh app.tar.gz  # ì••ì¶• íŒŒì¼ í¬ê¸° í™•ì¸

      # 5ï¸âƒ£ ì„¤ì • íŒŒì¼ ì¤€ë¹„
      - name: Prepare configuration directory
        run: |
          mkdir -p config
          # ì„¤ì • íŒŒì¼ì„ ë™ì ìœ¼ë¡œ ìƒì„±
          echo "${{ secrets.APPLICATION_DEV_YML }}" > config/application-dev.yml
          echo "${{ secrets.APPLICATION_AWS_YML }}" > config/application-aws.yml
          echo "ì„¤ì • íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ:"
          ls -la config/

      # 6ï¸âƒ£ ì••ì¶• íŒŒì¼ ë° Docker ì„¤ì • íŒŒì¼, ì„¤ì • íŒŒì¼ ì „ì†¡
      - name: Upload compressed JAR
        uses: appleboy/scp-action@v0.1.3
        with:
          host: 13.209.77.214
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "app.tar.gz"
          target: "/home/ubuntu/app"
          timeout: 30m

      - name: Upload Docker config files to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          host: 13.209.77.214
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "Dockerfile,.dockerignore"
          target: "/home/ubuntu/app"

      - name: Upload application config files to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          host: 13.209.77.214
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "config/*"
          target: "/home/ubuntu/app"
          timeout: 5m

      # 7ï¸âƒ£ ì••ì¶• í•´ì œ ë° Docker ì´ë¯¸ì§€ ë¹Œë“œ, ì»¨í…Œì´ë„ˆ ì‹¤í–‰
      - name: Deploy with Docker
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 13.209.77.214
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/ubuntu/app
            
            # ê¸°ì¡´ íŒŒì¼/ë””ë ‰í† ë¦¬ ì‚­ì œ í›„ ì••ì¶• í•´ì œ
            rm -rf app.jar
            mkdir -p temp_extract
            tar -xzf app.tar.gz -C temp_extract
            mv temp_extract/app.jar ./app.jar
            rm -rf temp_extract app.tar.gz
            
            # JAR íŒŒì¼ ê²€ì¦
            echo "ğŸ” JAR íŒŒì¼ í¬ê¸° í™•ì¸:"
            ls -lh app.jar
            
            # ì„¤ì • íŒŒì¼ ë””ë ‰í† ë¦¬ í™•ì¸
            echo "ğŸ” ì„¤ì • íŒŒì¼ í™•ì¸:"
            mkdir -p config
            ls -la config/
            
            # JAR íŒŒì¼ ìœ íš¨ì„± í™•ì¸
            file app.jar
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ë° ì‚­ì œ
            docker stop matajo-app || true
            docker rm matajo-app || true

            # ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ (ì„ íƒì‚¬í•­)
            docker image prune -f

            # ìƒˆë¡œìš´ Docker ì´ë¯¸ì§€ ë¹Œë“œ
            docker build -t matajo:latest .

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d \
              --name matajo-app \
              -p 8080:8080 \
              -v /home/ubuntu/app/config:/app/config \
              -e SPRING_CONFIG_LOCATION=file:/app/config/ \
              --restart always \
              -v /home/ubuntu/app/logs:/app/logs \
              matajo:latest

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            sleep 10
            if [ "$(docker ps -q -f name=matajo-app)" ]; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤"
              docker logs matajo-app --tail 50
            else
              echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
              docker logs matajo-app
              exit 1
            fi